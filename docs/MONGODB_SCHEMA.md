# üóÑÔ∏è MongoDB Schema - Manufacturing Process Monitoring System

## üìã **Schema Overview**

This document describes the MongoDB collections and their schemas, converted from the PostgreSQL database schema to MongoDB using Mongoose ODM.

---

## üèóÔ∏è **Collections**

### **1. Users Collection**

Stores user accounts (admins and workers).

```typescript
{
  _id: ObjectId,
  username: String (optional, unique),      // Employee number for workers
  name: String (required),               // Full name
  email: String (optional, unique),      // Email address
  password: String (required),           // Hashed password
  role: String (required),               // 'admin' | 'worker'
  isActive: Boolean (default: true),     // Account status
  lastLoginAt: Date,                     // Last login timestamp
  failedLoginAttempts: Number (default: 0),
  lockedUntil: Date,                     // Account lock expiration
  createdAt: Date,                       // Auto-generated
  updatedAt: Date                        // Auto-generated
}
```

**Indexes:**

- `username` (unique, sparse)
- `email` (unique, sparse)
- `role`
- `isActive`

---

### **2. Projects Collection**

Stores manufacturing projects with snapshot architecture for immutability.

```typescript
{
  _id: ObjectId,
  name: String (required),               // Project name
  description: String,                   // Project description
  products: Array [                      // Products to manufacture
    {
      productId: ObjectId (ref: Product),
      snapshot: Object,                  // Frozen product data
      targetQuantity: Number,
      producedQuantity: Number
    }
  ],
  recipes: Array [                       // Recipes to execute
    {
      recipeId: ObjectId (ref: Recipe),
      snapshot: Object,                  // Frozen recipe data with raw materials
      targetQuantity: Number,
      producedQuantity: Number
    }
  ],
  status: String (required),             // 'PLANNING' | 'ACTIVE' | 'ON_HOLD' | 'COMPLETED' | 'CANCELLED'
  priority: String (required),           // 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT'
  startDate: Date (required),            // Project start date
  endDate: Date (required),              // Project end date
  deadline: Date,                        // Optional deadline
  progress: Number (0-100),              // Auto-calculated completion percentage
  createdBy: ObjectId (ref: User),       // Creator user ID
  createdAt: Date,
  updatedAt: Date
}
```

**Indexes:**

- `status`
- `priority`
- `startDate, endDate`
- `createdBy`
- `products.productId`
- `recipes.recipeId`

**Important Notes:**

- Products and recipes are **snapshotted** at project creation (immutable)
- Progress auto-calculated via pre-save hook based on producedQuantity vs targetQuantity
- Snapshots include full recipe steps and raw material data

---

### **3. Recipes Collection**

Stores manufacturing recipes with steps and raw material requirements.

```typescript
{
  _id: ObjectId,
  recipeNumber: String (unique, sparse),  // Optional unique identifier
  version: Number (default: 1),           // Recipe version
  name: String (required),                // Recipe name
  description: String,                    // Recipe description
  rawMaterials: Array [                   // Required raw materials
    {
      materialId: ObjectId (ref: RawMaterial),
      quantityRequired: Number            // Quantity per unit produced
    }
  ],
  steps: Array [                          // Recipe steps (subdocuments)
    {
      _id: ObjectId (auto-generated),     // MongoDB auto-generated ID
      order: Number (required),           // Step execution order
      name: String (required),            // Step name
      description: String,                // Step description
      estimatedDuration: Number,          // Duration in minutes
      deviceId: String (ref: Device),     // Required device
      qualityChecks: Array<String>,       // Quality check list
      dependsOn: Array<ObjectId>,         // Dependent step _ids
      media: Array [                      // Step media (subdocuments)
        {
          _id: ObjectId (auto-generated), // MongoDB auto-generated ID
          filename: String,
          originalName: String,
          mimeType: String,
          fileSize: Number,
          filePath: String,
          mediaType: String,              // 'INSTRUCTION' | 'DIAGRAM' | 'VIDEO' | 'QUALITY_CHECK'
          description: String,
          uploadedAt: Date
        }
      ]
    }
  ],
  estimatedDuration: Number,              // Total duration (auto-calculated)
  createdAt: Date,
  updatedAt: Date
}
```

**Indexes:**

- `recipeNumber, version` (unique compound, sparse)
- `name`
- `rawMaterials.materialId`

**Important Notes:**

- Step `_id` and media `_id` are **auto-generated by MongoDB**
- No manual `stepId` or `mediaId` fields
- `estimatedDuration` calculated via pre-save hook (sum of all steps)

---

### **4. RawMaterials Collection**

Stores raw material inventory and specifications.

```typescript
{
  _id: ObjectId,
  materialCode: String (required, unique), // Unique code (e.g., "MAT-001")
  name: String (required),                 // Material name
  materialType: String (required),         // Type (e.g., "METAL", "PLASTIC")
  specifications: Object {                 // Material specifications
    dimensions: {
      length: Number,
      width: Number,
      height: Number,
      unit: String                         // e.g., "mm", "cm"
    },
    weight: {
      value: Number,
      unit: String                         // e.g., "kg", "g"
    },
    color: String
  },
  supplier: String,                        // Optional supplier name
  unit: String,                            // Unit of measure
  currentStock: Number (default: 0),       // Current stock quantity
  createdAt: Date,
  updatedAt: Date
}
```

**Indexes:**

- `materialCode` (unique)
- `materialType`
- `name`

**Important Notes:**

- Cannot be deleted if used in any recipe (cascade prevention)
- Snapshotted in project recipes for immutability

---

### **5. Products Collection**

Stores product definitions.

```typescript
{
  _id: ObjectId,
  designNumber: String (required, unique), // Product design number
  productName: String (required),          // Product name
  customerName: String,                    // Customer name
  quantityUnit: String,                    // Unit of measure
  recipes: Array [                         // Associated recipes
    {
      recipeId: ObjectId (ref: Recipe),
      recipeNumber: String,
      recipeName: String,
      isDefault: Boolean
    }
  ],
  createdAt: Date,
  updatedAt: Date
}
```

**Indexes:**

- `designNumber` (unique)
- `productName`
- `customerName`

**Important Notes:**

- Cannot be deleted if used in any project (cascade prevention)
- Snapshotted in projects for immutability

---

### **6. Devices Collection**

Stores device/tablet information.

```typescript
{
  _id: String,                           // Custom ID like 'DEVICE_001'
  name: String (required),               // Device name
  type: String (required),               // Device type (TABLET, WORKSTATION, etc.)
  location: String,                      // Physical location
  status: String (required),             // 'ONLINE' | 'OFFLINE' | 'MAINTENANCE' | 'ERROR'
  ipAddress: String,                     // Network IP address
  lastHeartbeat: Date,                   // Last connection timestamp
  config: Object (default: {}),          // Device-specific configuration
  createdAt: Date,
  updatedAt: Date
}
```

**Indexes:**

- `status`
- `type`
- `location`
- `lastHeartbeat`

---

### **7. Tasks Collection**

Stores work tasks assigned to devices and workers.

```typescript
{
  _id: ObjectId,
  title: String (required),              // Task title
  description: String,                   // Task description
  projectId: ObjectId (ref: Project),    // Associated project
  recipeId: ObjectId (ref: Recipe),      // Recipe being executed
  productId: ObjectId (ref: Product),    // Optional: Product being manufactured
  recipeStepId: ObjectId,                // Recipe step _id from project snapshot
  deviceId: String (ref: Device),        // Assigned device
  workerId: ObjectId (ref: User),        // Assigned worker (renamed from assignedTo)
  status: String (required),             // 'PENDING' | 'ONGOING' | 'PAUSED' | 'COMPLETED' | 'FAILED'
  priority: String (required),           // 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT'
  estimatedDuration: Number,             // Estimated time in minutes
  actualDuration: Number,                // Actual time in minutes
  startedAt: Date,                       // Task start timestamp
  completedAt: Date,                     // Task completion timestamp
  progress: Number (0-100),              // Task progress percentage
  notes: String,                         // Additional notes
  qualityData: Object,                   // Quality check results
  createdAt: Date,
  updatedAt: Date
}
```

**Indexes:**

- `projectId`
- `recipeId`
- `productId`
- `deviceId`
- `workerId`
- `status`
- `priority`
- `startedAt, completedAt`

**Important Notes:**

- `workerId` is required when status changes to `ONGOING` or `COMPLETED` (enforced by pre-save hook)
- `recipeStepId` references the step `_id` from the project's recipe snapshot (immutable)
- Tasks use snapshot data from project, not master recipe data

---

### **8. TaskMedia Collection**

Stores files/media attached to tasks.

```typescript
{
  _id: ObjectId,
  taskId: ObjectId (ref: Task),          // Associated task
  filename: String (required),           // Stored filename
  originalName: String (required),       // Original filename
  mimeType: String (required),           // File MIME type
  fileSize: Number (required),           // File size in bytes
  filePath: String (required),           // Storage path
  uploadedBy: ObjectId (ref: User),      // Uploader user ID
  uploadType: String (required),         // 'PHOTO' | 'VIDEO' | 'DOCUMENT' | 'AUDIO'
  createdAt: Date
}
```

**Indexes:**

- `taskId`
- `uploadType`
- `uploadedBy`

---

### **9. Alerts Collection**

Stores system alerts and notifications.

```typescript
{
  _id: ObjectId,
  type: String (required),               // 'INFO' | 'WARNING' | 'ERROR' | 'EMERGENCY'
  level: String (required),              // 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL'
  title: String (required),              // Alert title
  message: String (required),            // Alert message
  source: String,                        // Alert source (e.g., 'SYSTEM', 'DEVICE_001')
  relatedEntityType: String,             // Entity type ('TASK', 'PROJECT', 'DEVICE')
  relatedEntityId: String,               // Entity ID
  status: String (required),             // 'UNREAD' | 'READ' | 'ACKNOWLEDGED' | 'RESOLVED'
  acknowledgedBy: ObjectId (ref: User),  // User who acknowledged
  acknowledgedAt: Date,                  // Acknowledgment timestamp
  resolvedAt: Date,                      // Resolution timestamp
  metadata: Object (default: {}),        // Additional data
  createdAt: Date
}
```

**Indexes:**

- `type`
- `level`
- `status`
- `source`
- `relatedEntityType, relatedEntityId`
- `createdAt` (descending)

---

### **10. EmergencyReports Collection**

Stores emergency incident reports.

```typescript
{
  _id: ObjectId,
  deviceId: String (ref: Device),        // Reporting device
  reportedBy: ObjectId (ref: User),      // Reporter user ID
  type: String (required),               // Report type
  severity: String (required),           // 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL'
  title: String (required),              // Report title
  description: String (required),        // Detailed description
  location: String,                      // Incident location
  status: String (required),             // 'OPEN' | 'INVESTIGATING' | 'RESOLVED' | 'CLOSED'
  assignedTo: ObjectId (ref: User),      // Assigned investigator
  resolvedBy: ObjectId (ref: User),      // Resolver user ID
  resolvedAt: Date,                      // Resolution timestamp
  resolutionNotes: String,               // Resolution details
  createdAt: Date,
  updatedAt: Date
}
```

**Indexes:**

- `deviceId`
- `reportedBy`
- `status`
- `severity`
- `createdAt` (descending)

---

### **11. KPIData Collection**

Stores Key Performance Indicator metrics.

```typescript
{
  _id: ObjectId,
  metricName: String (required),         // Metric name
  metricValue: Number (required),        // Metric value
  unit: String,                          // Unit of measurement
  deviceId: String (ref: Device),        // Associated device
  projectId: ObjectId (ref: Project),    // Associated project
  recordedAt: Date (required),           // Measurement timestamp
  metadata: Object (default: {}),        // Additional metric data
  createdAt: Date
}
```

**Indexes:**

- `metricName`
- `recordedAt` (descending)
- `deviceId`
- `projectId`
- `metricName, recordedAt` (compound, descending)

---

### **12. Reports Collection**

Stores generated reports.

```typescript
{
  _id: ObjectId,
  title: String (required),              // Report title
  type: String (required),               // 'PRODUCTION' | 'QUALITY' | 'MAINTENANCE' | 'EFFICIENCY'
  format: String (required),             // 'PDF' | 'EXCEL' | 'CSV' | 'JSON'
  parameters: Object (default: {}),      // Report generation parameters
  filePath: String,                      // Storage path
  fileSize: Number,                      // File size in bytes
  status: String (required),             // 'PENDING' | 'PROCESSING' | 'COMPLETED' | 'FAILED'
  generatedBy: ObjectId (ref: User),     // Generator user ID
  generatedAt: Date,                     // Generation timestamp
  expiresAt: Date,                       // Expiration timestamp
  downloadCount: Number (default: 0),    // Download counter
  errorMessage: String,                  // Error details if failed
  createdAt: Date
}
```

**Indexes:**

- `type`
- `status`
- `generatedBy`
- `createdAt` (descending)

---

### **13. ActivityLogs Collection**

Stores user activity logs for audit trail.

```typescript
{
  _id: ObjectId,
  userId: ObjectId (ref: User),          // User who performed action
  action: String (required),             // Action performed
  resourceType: String (required),       // Resource type affected
  resourceId: String,                    // Resource ID
  details: Object (default: {}),         // Action details
  ipAddress: String,                     // User IP address
  userAgent: String,                     // User browser/device
  success: Boolean (default: true),      // Action success status
  errorMessage: String,                  // Error details if failed
  durationMs: Number,                    // Action duration in milliseconds
  createdAt: Date
}
```

**Indexes:**

- `userId`
- `action`
- `resourceType, resourceId`
- `createdAt` (descending)
- `success`

---

### **14. Sessions Collection**

Stores user authentication sessions.

```typescript
{
  _id: ObjectId,
  userId: ObjectId (ref: User),          // Session owner
  deviceId: String (ref: Device),        // Device used
  accessTokenHash: String (required),    // Hashed access token
  refreshTokenHash: String (required),   // Hashed refresh token
  ipAddress: String,                     // Connection IP
  userAgent: String,                     // Browser/device info
  expiresAt: Date (required),            // Session expiration
  lastActivity: Date (default: now),     // Last activity timestamp
  isActive: Boolean (default: true),     // Session status
  createdAt: Date
}
```

**Indexes:**

- `userId`
- `deviceId`
- `accessTokenHash, refreshTokenHash`
- `expiresAt` (with TTL for auto-deletion)
- `isActive`

---

## üîÑ **Relationships**

### **One-to-Many:**

- User ‚Üí Projects (via `createdBy`)
- User ‚Üí Tasks (via `workerId`)
- Project ‚Üí Tasks (via `projectId`)
- Recipe ‚Üí Tasks (via `recipeId`)
- Product ‚Üí Tasks (via `productId`)
- Task ‚Üí TaskMedia (via `taskId`)
- Device ‚Üí Tasks (via `deviceId`)
- RawMaterial ‚Üí Recipe.rawMaterials (via `materialId`)

### **Many-to-Many:**

- Product ‚Üî Recipe (via `recipes` array in Product)
- Recipe ‚Üî RawMaterial (via `rawMaterials` array in Recipe)

### **Snapshot Relationships:**

- Project snapshots Product data (immutable)
- Project snapshots Recipe data including steps and raw materials (immutable)
- Task references snapshot data from Project (not master data)

### **One-to-One:**

- User ‚Üí Sessions (per active session)

---

## üöÄ **Migration from PostgreSQL Differences**

### **Key Changes:**

1. **ObjectId vs UUID**: MongoDB uses ObjectId instead of UUID
2. **Custom IDs**: Device collection uses custom string IDs
3. **No Foreign Key Constraints**: MongoDB uses references instead
4. **Embedded Documents**: `metadata` and `config` stored as embedded objects
5. **TTL Indexes**: Sessions auto-delete when expired
6. **Sparse Indexes**: Used for optional unique fields (username, email)

### **MongoDB Advantages:**

- Flexible schema with Mixed types for metadata
- Better performance for read-heavy operations
- Embedded documents reduce joins
- Automatic TTL cleanup for sessions
- Easier horizontal scaling

---

## üìù **Usage Examples**

### **Creating a User:**

```typescript
const user = new User({
  username: "EMP001",
  name: "John Worker",
  email: "john@example.com",
  password: hashedPassword,
  role: "worker"
});
await user.save();
```

### **Querying with Population:**

```typescript
const tasks = await Task.find({ status: "ONGOING" })
  .populate("projectId")
  .populate("workerId", "name username")
  .populate("deviceId");
```

### **Creating Indexes:**

All indexes are automatically created when the models are first accessed. You can also manually ensure indexes:

```typescript
await User.ensureIndexes();
await Project.ensureIndexes();
// ... for all models
```

---

## üîß **Performance Optimization**

1. **Compound Indexes**: Used for common query patterns
2. **TTL Indexes**: Automatic cleanup of expired sessions
3. **Sparse Indexes**: For optional unique fields
4. **Descending Indexes**: For time-based queries (latest first)
5. **Text Indexes**: Can be added for full-text search if needed

---

This MongoDB schema provides a robust foundation for the Manufacturing Process Monitoring System with proper indexing, relationships, and flexibility for future enhancements! üöÄ
